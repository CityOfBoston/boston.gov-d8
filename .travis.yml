sudo: false
language: php

branches:
  only:
    - develop
    - master
    - "replace-phing"

php:
  - 7.3

services:
  - mysql

addons:
  apt:
    update: true
    packages:
      - libssl1.0.0
  ssh_known_hosts:
    - svn-29892.prod.hosting.acquia.com
    - bostond8dev.ssh.prod.acquia-sites.com

cache:
  bundler: true
  apt: true
  directories:
    - "$HOME/.composer/cache"
    - "$HOME/.drush/cache"
    - "$HOME/.nvm"
    - vendor
    - docroot
    - node_modules

notifications:
  slack:
    on_pull_requests: true
    if: branch = master OR branch = develop
    rooms:
      - secure: "spxqL9DjJS53tXkTxQxyyq/sbANHxGu+fIQGtixE8NS+9QV/A0UJAJEJY8vXAMEe18v+NTFJQRvS/STTysfpAyE/9yRFU9u1aGlZ3GZTYDvlLObYZMzpfAqENYw+Z2LQwKv7U7yhN7VHfKz6sWF5UMJ9UyCsFBSE5RuuPq5fR3FhC2RQilgu3wfWqNoCQrO3NA9WEKUeUyGcj51AH7lSWDQjZevECttezeb2SFpw3Fhyt6lgJMhYNawdgrWqLT/ewZwoO9x9AloGZFXtzAjz5psty/TmrWroiFjgqi16OYAGRpd8AWHYfhHt1N7qFBxxUGiQCtJg6ohZM7HOJvLbBd7Rc8gj0MgV6ePxtf2ByVyku6Bip1u7sfj+CqGYlnuKyHc/8rSzwEc9zQAPx6ZDDTGV+zkuBnAc+GjGxsheXiM+4QAn6liir+mglcGp/AxPeRmmQ7DIcmrDNI8dGsTaDMlBeufsU8eaMHGR2GeSnwnXT121M5fOEnE0G+m4L8y1t9J1gpo+py8GqhykJhxJHPkw8USxHRXoVVkgxOFW2AsfDBp6H43FwccfN7gHR+KPHeFq3ni4iagaBTFfmGp/CE+dpqk7E2qJte5qeppxwe94HCO1XAhWWMheZMC7Y3XK457IfWIdeB1gU2m5X1DDOE6GK5Llp7l/Wjo5cKNY8fI="
      - secure: "vNNEgntveFOhLF9qTD1Z9SJyoNCRtnKmbRHDRnuyLo0JTpbEPZGvmPg3Lpef2EcZO+aWuOsQBz1Dx/0rspWf/BBJcZflsk8uadiE8JkV5H6ls48F3H7Ez440c4cq+F/7S3Ly3B/FyskLl64lbU+MPc/HaOv9BrZuKSc8OYR5D6vPpNWfay6ix1Nci7xyr7HUtK0/zsj9DamWb7vixj1rpvYcXNAM012bxghb6s0TAYrr4m62Ww83TvuSN2PYNr727BgCZlmWEDyNujH9nAMmIxG9T5vGiHT2srRit8jlRMzqIONr/kjobtNmThRLcYwHebvk+nf2c7D+hDr05ku3RJwNgJtOqPU2ah8NH6Ngpb82nq58b0UwFHy0XcM1hveYUxir1y7kXy0azgeP2U7G0v4yABmEPFnUjlJeMiYhwSIynobmBqeVs2gFQSisOcAwaxPjuTGEA8bIxUkv9tUHKdw+Gh9Bt12OU/owKbqSDDb9iFUf/SjutgSb1QPPO0tA4ZnUwLZyFyXfUS2duoJw4gWG8KLNbWgIdmAAx+4Srb768xOu1UF688mGVtux6C6hsQhtrp0H36hXwDoiTyKxndle+63wNB5VvrOUpaBaw9Cb73a+uA8QS5aq7hzDBuQko1E0gpE2mEgHP7//e/P/kKWH3h84OynxNH/+TmRZxXY="

before_install:
  # Add in some required packages (ref: <reporoot>/.lando.yml
  - ${TRAVIS_BUILD_DIR}/scripts/deploy/travis_server_customize.sh

install:
  - travis_wait 30 ${TRAVIS_BUILD_DIR}/scripts/deploy/travis_build.sh

script:
  # D7's .travis.yml ran basic validation and Behat/PHPUnit tests in parallel.  We don't do this in D8 because it
  # causes multiple containers to be created, and if tests pass, multiple (near simultaneous) deployments (to Acquia)
  # of monitored branches.
  # NOTE: If you do not specify a script, then a PHPUnit command will be executed, and fail.
  - if [[ "${TRAVIS_PULL_REQUEST}" == "false" ]]; then ${TRAVIS_BUILD_DIR}/scripts/local/validate.sh none; fi

after_success:
  # Manage SSH keys for deployment to Acquia.
  - openssl aes-256-cbc -K $ACQUIA_KEY -iv $ACQUIA_VECTOR -in $TRAVIS_BUILD_DIR/scripts/deploy/acquia.enc -out $TRAVIS_BUILD_DIR/scripts/deploy/acquia_deploy -d
  - chmod 600 $TRAVIS_BUILD_DIR/scripts/deploy/acquia_deploy
  - eval "$(ssh-agent -s)"
  - ssh-add $TRAVIS_BUILD_DIR/scripts/deploy/acquia_deploy

deploy:
  - provider: script
    skip_cleanup: true
    script: bash $TRAVIS_BUILD_DIR/scripts/deploy/travis_deploy.sh $TRAVIS_BRANCH
    on:
      branch: develop
  - provider: script
    skip_cleanup: true
    script: bash $TRAVIS_BUILD_DIR/scripts/deploy/travis_deploy.sh $TRAVIS_BRANCH
    on:
      branch: "replace-phing"
  - provider: script
    skip_cleanup: true
    script: bash $TRAVIS_BUILD_DIR/scripts/deploy/travis_deploy.sh $TRAVIS_BRANCH
    on:
      branch: master
