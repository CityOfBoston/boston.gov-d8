<?php

/*
  Main Drupal module for bos_search

  david 06 2024
  @file docroot/modules/custom/bos_components/modules/bos_search/bos_search.module

*/

use Drupal\Core\Render\Element;
use Drupal\Core\Url;

/**
 * Implements hook_theme().
 */
function bos_search_theme($existing, $type, $theme, $path) {

  // Auto discover search results templates.
  $templates = glob(\Drupal::service("extension.list.module")->getPath('bos_search') . "/templates/search_results/*.html.twig");
  foreach ($templates as $template) {
    $template = basename($template);
    $template = str_replace(".html.twig", "", $template);
    $discovered[$template] = [
      'template' => "search_results/$template",
      'variables' => [
        "response" => NULL,
        "items" => NULL,
        "metadata" => NULL,
        "references" => NULL,
        "citations" => NULL,
        "content" => NULL,
        "id" => NULL,
      ],
    ];
  }

  /**
   * This defines the ai-enabled search button.
   */
  return array_merge($discovered, [
    'aisearch-button' => [
      'template' => 'snippets/aisearch_button',
      'variables' => [
        'search_form_url' => '/search',
        'button_title' => '',
        'button_css' => '',
        'preset' => '',
      ],
    ],
    'container--default' => [
      "template" => "form_elements/default/container",
      "base_hook" => "container",
      "render element" => "children",
    ],
    'details--default' => [
      "template" => "form_elements/default/details",
      "base_hook" => "details",
      "render element" => "children",
    ],
    'fieldset--default' => [
      "template" => "form_elements/default/fieldset",
      "base_hook" => "fieldset",
      "render element" => "children",
    ],
    'form--default' => [
      "template" => "form_elements/default/form",
      "base_hook" => "form",
      "render element" => "children",
    ],
    'form-element--default' => [
      "template" => "form_elements/default/form_element",
      "base_hook" => "form_element",
      "render element" => "children",
    ],
    'form-element-label--default' => [
      "template" => "form_elements/default/form_element_label",
      "base_hook" => "form_element_label",
      "render element" => "children",
    ],
    'checkboxes--default' => [
      "template" => "form_elements/default/checkboxes",
      "base_hook" => "checkboxes",
      "render element" => "children",
    ],
    'input--default' => [
      "template" => "form_elements/default/input",
      "base_hook" => "input",
      "render element" => "children",
    ],
    'radios--default' => [
      "template" => "form_elements/default/radios",
      "base_hook" => "radios",
      "render element" => "children",
    ],
    'select--default' => [
      "template" => "form_elements/default/select",
      "base_hook" => "select",
      "render element" => "children",
    ],
    'textarea--default' => [
      "template" => "form_elements/default/textarea",
      "base_hook" => "textarea",
      "render element" => "children",
    ],
    'submit--default' => [
      "template" => "form_elements/default/submit",
      "base_hook" => "button",
      "render element" => "children",
    ],
  ]);

}

/**
 * Implements hook_preprocess_HOOK().
 */
function bos_search_preprocess_page(&$variables) {
  /**
   * This renders the search button into the secondary_nav object.
   * TODO: need to control if/how this is enabled for a page.
   */
//  $variables['page']['content']['aisearch-button'] = [
//    '#theme' => 'aisearch-button',
//    '#search_form_url' => Url::fromRoute('bos_search.open_AISearchForm'),
//    '#button_title' => 'Search', // This has no setting in this embed style
//    '#button_css' => '',   // This has no setting in this embed style
//    '#preset' => '',  // TODO: How do we set this?
//  ];
}

/**
 * Implements hook_preprocess().
 */
function bos_search_preprocess(&$variables, $hook) {
  switch ($hook) {
    case "input":
      if (!empty($variables["element"]) && ($variables["element"]["#theme"] ?? "") == "input--default") {
        unset($variables["element"]);
        unset($variables["children"]);
      }
      break;
    case "form--default":
      if ($variables["children"]["#form_id"] == "bos_search_AISearchForm") {
        $variables["#attached"]["library"][] = "bos_search/overrides";
      }
      break;
    case "textarea--default":
      $variables["attributes"] = [
        "id" => $variables["children"]["#id"],
        "name" => $variables["children"]["#name"],
        "cols" => $variables["children"]["#cols"],
      ];
      $variables["value"] = $variables["children"]["#value"];
      break;
    case "fieldset--default":
    case "container--default":
    case "input--default":
    case "form_element_label--default":
    case "select--default":
    case "form_element--default":
    default:
      break;
  }

}

/**
 * Implements hook_theme_suggestions_alter().
 */
function bos_search_theme_suggestions_alter(array &$suggestions, array &$variables, $hook) {
  if (!empty($variables["children"]) && is_array($variables["children"]) &&
    (in_array("AiSearchForm", ($variables["children"]["#array_parents"] ?? []))
    || $variables["children"]["#form_id"] == "bos_search_AISearchForm")
    ) {
    switch ($hook) {
      case "form":
        $suggestions[] = "form--default";
    }
  }
}
