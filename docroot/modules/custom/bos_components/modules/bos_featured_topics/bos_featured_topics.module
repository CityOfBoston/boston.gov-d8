<?php

/**
 * @file
 * The Base module file for bos_featured_topics module.
 */

use Drupal\Core\Render\Element;
use Drupal\media\Entity\Media;
use Drupal\file\Entity\File;

/**
 * Implements hook_theme().
 */
function bos_featured_topics_theme() {
  $theme['paragraph__featured_topics'] = [
    'base hook' => 'paragraph',
  ];
  $theme['field__component__field_title'] = [
    'base hook' => 'paragraph',
  ];
  $theme['field__component__field_topics'] = [
    'base hook' => 'paragraph',
  ];
  return $theme;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function bos_featured_topics_preprocess_paragraph__featured_topics(&$variables, $hook, $info) {
  // Add a numeric which indicates the sequence number in the array.
  foreach (Element::getVisibleChildren($variables["content"]["field_topics"]) as $seq) {
    $variables["content"]["field_topics"][$seq]["#seq"] = $seq;
    $variables["content"]["field_topics"][$seq]["#weight"] = $seq;
  }
  // @var $paragraph Drupal\paragraphs\Entity\Paragraph.
  $paragraph = $variables['paragraph'];
  // @var $field_topics Drupal\Core\Field\EntityReferenceFieldItemList.
  $field_topics = $paragraph->get('field_topics');
  // @var $guide \Drupal\node\Entity\Node.
  foreach ($field_topics->referencedEntities() as $guide) {
    $uri = $guide->get('field_intro_image')->entity->get('image')->entity->uri->value;
    $intro_image = $guide->get('field_intro_image')->getValue();
    $mid = $intro_image[0]['target_id'];
    // @var $media Drupal\media\Entity\Media.
    $media = Media::load($mid);
    //$media_field = $media->get('field_media_image')->first()->getValue();
    //$file = File::load($media_field['target_id']);
    if ($file) {
      $background = $file->getFileUri();
      $variables['background'] = file_create_url($background);
    }
    //$fid = $media->field_media_image->target_id;
    //$file = File::load($fid);
    //$url = $file->url();
    $test = 'test';
  }
}
