<?php

/**
 * @file
 * The Base module file for bos_messages module.
 */

use Drupal\Component\Utility\Xss;

/**
 * Implements hook_theme().
 */
function bos_messages_theme($existing, $type, $theme, $path) {
  return [
    'bos_messages_mod_recur_widget' => [
      'render element' => 'widget',
    ],
    'paragraph__message_for_the_day' => [
      'base hook' => 'paragraph',
      'path' => drupal_get_path('module', 'bos_messages') . '/templates',
    ],
  ];
}

/**
 * Implements hook_preprocess_paragraph().
 */
function bos_messages_preprocess_paragraph(&$vars) {
  if (!empty($vars['paragraph'])) {
    $paragraph = $vars['paragraph'];
    switch ($paragraph->bundle()) {
      case 'message_for_the_day':
        if (!$paragraph->get('field_link')->isEmpty()) {
          $link = _bos_core_paragraph_extract_link($paragraph->get('field_link')->getValue());
          $vars['card_url'] = $link['url'];
        }
        if ($paragraph->get('field_use_alert')->Getvalue()['0']['value']) {
          $alert = file_get_contents(drupal_get_path('module', 'bos_messages') . '/assets/alert.svg');
          $vars['alert'] = trim($alert);
        }
        if ($host = $paragraph->getParentEntity()) {
          if ($host->hasField('field_icon') && !$host->get('field_icon')->isEmpty()) {
            $fid = $host->get('field_icon')->getValue()['0']['target_id'];
            $uri = file_load($fid)->getFileUri();
            $icon = file_get_contents(file_create_url($uri));
            $vars['icon'] = Xss::filter($icon, explode(' ', BOS_CORE_SVG_ELEMENTS));
          }
          $vars['title'] = $host->label();
        }
        break;
    }
  }
}
