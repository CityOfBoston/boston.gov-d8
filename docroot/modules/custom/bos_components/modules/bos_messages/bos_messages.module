<?php

/**
 * @file
 * The Base module file for bos_messages module.
 */

use Drupal\Component\Utility\Xss;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\Markup;
use Drupal\editor\Entity\Editor;
use Drupal\file\Entity\File;
use Drupal\media\Entity\Media;
use Drupal\paragraphs\Entity\Paragraph;

/**
 * Implements hook_theme().
 */
function bos_messages_theme($existing, $type, $theme, $path) {
  return [
    'bos_messages_mod_recur_widget' => [
      'render element' => 'widget',
    ],
    'paragraph__message_for_the_day' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__message_for_the_day__listing' => [
      'base hook' => 'paragraph',
    ],
  ];
}

/**
 * Implements hook_form_alter().
 */
function bos_messages_form_node_status_item_edit_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form["#attached"]["library"][] = "bos_messages/mod.assets";
}

/**
 * Implements hook_preprocess_paragraph().
 */
function bos_messages_preprocess_paragraph__message_for_the_day__listing(&$variables) {
  static $motd_processed = [];

  $motd = $variables['paragraph'];
  $status_item = $motd->getParentEntity();

  $variables["show_message"] = FALSE;

  // Only do this if the parent status_item hasn't already had a message
  // processed.
  if (isset($status_item) && !isset($motd_processed[$status_item->id()])) {

    // Make sure the recurrences field has a value.
    if (isset($variables["content"]["field_recurrence"][0]['#occurrences'])
      && count($variables["content"]["field_recurrence"][0]['#occurrences'])) {

      $date = $variables["content"]["field_recurrence"][0]['#occurrences'][0];
      $today = new \DateTime();
      $today->modify("-5 hours");

      // If $today is in the occurence range then show.
      if (!empty($date) && isset($date["start_date"]) && isset($date["end_date"])) {
        $start_date = new \DateTime($date["start_date"]["#text"]);
        $end_date = new \DateTime($date["end_date"]["#text"]);
        if ($today >= $start_date && $today <= $end_date) {
          $variables["show_message"] = TRUE;
          $motd_processed[$status_item->id()] = $motd->id();
        }
      }
    }

    if (!empty($variables["show_message"])) {
      if (isset($motd->field_link[0])) {
        $paragraph = Paragraph::load($motd->field_link[0]->target_id);
        if (NULL != $link = _bos_core_paragraph_extract_link($paragraph)) {
          $variables['card_url'] = $link['url'];
        }
      }

      if (!empty($motd->field_use_alert->value)) {
        $alert = file_get_contents(drupal_get_path('module', 'bos_messages') . '/assets/alert.svg');
        $variables['alert'] = Xss::filter($alert, explode(' ', BOS_CORE_SVG_ELEMENTS));
      }

      // Get the field_icon uri from the parent status_item.
      if (NULL != ($fid = $status_item->field_icon->target_id)) {
        $media = Media::load($fid);
        if (!empty($media->image) && NULL != ($mid = $media->image->target_id)) {
          if (NULL != ($file = File::load($mid))) {
            $uri = $file->getFileUri();
            if (\Drupal::service('file_system')->realpath($uri)) {
              $uri = \Drupal::service('file_system')->realpath($uri);
            }
            // If the icon is in the format //domain/file then add scheme.
            if (substr($uri, 0, 4) != "http") {
              $uri = \Drupal::request()->getScheme() . ":" . $uri;
            }

            if ($icon = @file_get_contents($uri)) {
              $variables['icon'] = Xss::filter($icon, explode(' ', BOS_CORE_SVG_ELEMENTS));
            }
            else {
              $icon = @file_get_contents(file_create_url("public://custom/no-icon.svg"));
              $variables['icon'] = Xss::filter($icon, explode(' ', BOS_CORE_SVG_ELEMENTS));
            }

          }
        }
      }

      // Set the title to be the display_title.
      $variables['title'] = $status_item->field_title->value;
    }
  }

}

/**
 * Implements hook_contact_token_info().
 */
function bos_messages_token_info() {
  $info = [];
  // Define our new token.
  $info['tokens']['boston']['week-ordinal:value'] = [
    'name' => t('Current Week-ord (num)'),
    'description' => t("The current date's week number in this month <i>(e.g. 2nd)</i>."),
  ];
  $info['tokens']['boston']['week-ordinal:text'] = [
    'name' => t('Current Week-ord (txt)'),
    'description' => t("The current date's week number in this month <i>(e.g. second)</i>."),
  ];
  $info['tokens']['boston']['week-day'] = [
    'name' => t('Current Date - weekday'),
    'description' => t('Today in the "l" format <i>(e.g Monday)</i>.'),
  ];
  return $info;
}

/**
 * Implements hook_tokens().
 */
function bos_messages_tokens($type, $tokens, array $data = [], array $options = []) {
  $replacements = [];

  if ($type == 'boston') {
    // Loop through the available tokens.
    foreach ($tokens as $name => $original) {
      // Find our custom tokens by name.
      switch ($name) {
        case 'week-ordinal:value':
          // Give our token it's final value!
          $now = new DateTime();
          $weekday = date_format($now, "l");
          $month = date_format($now, "F");
          foreach (["1st", "2nd", "3rd", "4th", "5th"] as $ordinal) {
            if (strtotime("today") == strtotime(sprintf("%s %s of %s", $ordinal, $weekday, $month))) {
              break;
            }
          }
          $replacements[$original] = $ordinal;
          break;

        case 'week-ordinal:text':
          // Give our token it's final value!
          $now = new DateTime();
          $weekday = date_format($now, "l");
          $month = date_format($now, "F");
          foreach (["first", "second", "third", "fourth", "fifth"] as $ordinal) {
            if (strtotime("today") == strtotime(sprintf("%s %s of %s", $ordinal, $weekday, $month))) {
              break;
            }
          }
          $replacements[$original] = $ordinal;
          break;

        case 'week-day':
          // Give our token it's final value!
          $replacements[$original] = date_format(new DateTime(), "l");
          break;

      }
    }
  }

  return $replacements;
}

/**
 * Implements hook_paragraph_HOOK_summary_alter().
 */
function bos_messages_paragraph_message_for_the_day_summary_alter(array $form_widget, array $para, array $attributes) {
  $attributes["class"][] = $para["entity"]->field_enabled->value ? "cob-para-enabled" : "cob-para-disabled";
  $at_settings = [
    'word_boundary' => TRUE,
    'ellipsis' => TRUE,
    'max_length' => 30,
  ];
  $message = html_entity_decode(strip_tags($para["entity"]->get("field_message")->value));
  $message = preg_replace("/\[[a-zA-Z\:\-_\.]*\]/", "{token}", $message) ?: "";
  $message = advanced_text_formatter_trim_text($message, $at_settings);
  $markup[] = Markup::create("<span class='body-text'>" . $message . "</span>");
  $pattern = $para["entity"]->get("field_recurrence");
  $patt = explode(";", $pattern->rrule);
  foreach ($patt as $key => $value) {
    $parts = explode("=", $value);
    $pattern->{$parts[0]} = $parts[1];
  }
  $end = "";
  if (!empty($pattern->UNTIL)) {
    $end = "until " . \Drupal::service('date.formatter')
      ->format(strtotime($pattern->UNTIL), "custom", "M d Y");
  }
  $recur = t("every @interval @freq @until", [
    "@interval" => $pattern->INTERVAL ?: "",
    "@freq" => ($pattern->FREQ == "DAILY" ? "day" : "week"),
    "@until" => $end,
  ]);
  $pattern_msg = t("From: @from, @recur", [
    "@from" => \Drupal::service('date.formatter')->format(strtotime($pattern->value), "custom", "M d Y"),
    "@recur" => $recur,
  ]);
  $markup[] = Markup::create("<span class='info'>" . $pattern_msg . "</span>");

  return [
    'attributes' => $attributes,
    'content' => $markup,
  ];
}
