<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Url;
use Drupal\taxonomy\Entity\Term;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_theme().
 */
function node_elections_theme($existing, $type, $theme, $path) {
  return [
    'node__election_report__election_card' => [
      'base hook' => 'node',
    ],
    'paragraph__election_area_results__election_card' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__election_contest_results__election_card' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__election_card_full' => [
      'base hook' => 'paragraph',
    ],
    'paragraph__election_candidate_results__election_card' => [
      'base hook' => 'paragraph',
    ],
  ];
}

/**
 * Implements hook_preprocess_HOOK().
 */
function node_selections_preprocess_node(&$variables, $a) {

  if (isset($variables["node"]) && in_array($variables["node"]->bundle(), [
      "election_report",
      "node_election_uploader",
    ])) {
    $variables['#attached']['library'][] = 'node_elections/election';
  }

}

/**
 * Implements hook_preprocess_HOOK().
 */
function node_elections_preprocess_node(&$variables, $a) {

  if (isset($variables["node"]) && in_array($variables["node"]->bundle(), [
      "election_report",
    ])) {
    $variables['#attached']['library'][] = 'node_elections/election';
  }

}

/**
 * Implements hook_preprocess_HOOK().
 */
function node_elections_preprocess_paragraph(&$variables) {
  if (isset($variables["paragraph"]) && in_array($variables["paragraph"]->bundle(), [
    'election_area_results'
  ])) {
  }
}

/**
 * Implements hook_form_alter().
 */
function node_elections_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if (in_array($form_id, [
    "node_election_report_form",
    "node_election_report_edit_form",
  ])) {
    $form["#attached"]["library"][] = 'node_elections/election_admin';
  }
return;
  // Add in contextual filters for autocomplete textbozes.

  if ($form_id == "node_election_report_edit_form") {
    // In this scenario, we are adding some element to the form.
    // Get the nid for this node.
    if (!empty($form_state->getValues())) {
      $nid = $form_state->getFormObject()->getEntity()->id();
      foreach ($form_state->getValue("field_area_results", []) as $key => $value) {
        // cycle through any subforms being opened.
        if (array_key_exists("field_area_results", $form)
          && array_key_exists("subform", $form["field_area_results"]["widget"][$key])) {
          $sf = &$form["field_area_results"]["widget"][$key]["subform"];
          if (array_key_exists("field_election_area", $sf)) {
            // Set the contextual value to pass to the view.
            $sf["field_election_area"]["widget"][0]["target_id"]["#selection_settings"]["view"]["arguments"][0] = $nid;
          }
          if (array_key_exists("subform", $value)) {
            foreach ($value["subform"]["field_election_contest_results"] as $eckey => $ecValue) {
              if (array_key_exists("field_election_contest_results", $sf)
                && array_key_exists("subform", $sf["field_election_contest_results"]["widget"][$eckey])) {
                $sf = &$sf["field_election_contest_results"]["widget"][$eckey]["subform"];
                if (array_key_exists("field_election_contest", $sf)) {
                  // Set the contextual value to pass to the view.
                  $sf["field_election_contest"]["widget"][0]["target_id"]["#selection_settings"]["view"]["arguments"][0] = $nid;
                }
                if (array_key_exists("subform", $ecValue)) {
                  $tid = $sf["field_election_contest"]["widget"][0]["target_id"]["#default_value"]->id();
                  foreach ($ecValue["subform"]["field_candidate_results"] as $ecandkey => $ecandValue) {
                    if (array_key_exists("field_candidate_results", $sf)
                      && array_key_exists("subform", $sf["field_candidate_results"]["widget"][$ecandkey])) {
                      $sf = &$sf["field_candidate_results"]["widget"][$ecandkey]["subform"];
                      if (array_key_exists("field_election_candidate", $sf)) {
                        // Set the contextual value to pass to the view.
                        $sf["field_election_candidate"]["widget"][0]["target_id"]["#selection_settings"]["view"]["arguments"] = [
                          $nid,
                          $tid,
                        ];
                      }
                    }
                  }
                }
              }
            }
          }
        }
      }
    }

    if (!empty($form_state->getTriggeringElement())) {
      $nid = $form_state->getFormObject()->getEntity()->id();
      if (array_key_exists("#bundle_machine_name", $form_state->getTriggeringElement())) {
        switch ($form_state->getTriggeringElement()["#bundle_machine_name"]) {
          case "election_area_results":
            $area_delta = $form["field_area_results"]["widget"]["#max_delta"];
            $sf = &$form["field_area_results"]["widget"][$area_delta]["subform"];
            // Set the contextual value to pass to the view.
            $ea_delta = $sf["field_election_area"]["widget"]["#max_delta"] ?: 0;
            $sf["field_election_area"]["widget"][$ea_delta]["target_id"]["#selection_settings"]["view"]["arguments"] = [$nid];
            break;
          case "election_contest_results":
            $area_delta = $form["field_area_results"]["widget"]["#max_delta"];
            $sf = &$form["field_area_results"]["widget"][$area_delta]["subform"];
            $ea_delta = $sf["field_election_contest_results"]["widget"]["#max_delta"] ?: 0;
            $sf = &$sf["field_election_contest_results"]["widget"][$ea_delta]["subform"];
            $sf["field_election_contest"]["target_id"]["#selection_settings"]["view"]["arguments"] = [$nid];
            break;
          case "election_candidate_results":
            break;
        }
      }
    }
  }
}

/**
 * Implements hook_field_widget_complete_form_alter().
 */
function node_elections_field_widget_complete_entity_reference_autocomplete_form_alter(&$field_widget_complete_form, \Drupal\Core\Form\FormStateInterface $form_state, $context) {
  switch($field_widget_complete_form["widget"]["#field_name"]){
    case "field_election_area":
      $nid = $form_state->getFormObject()->getEntity()->id();
      /**
       * @var $widget \Drupal\Core\Field\Plugin\Field\FieldWidget\EntityReferenceAutocompleteWidget
       */
//      $widget = $context["widget"];
//      $widget->fieldDefinition();
      $field_widget_complete_form["widget"][0]["target_id"]["#selection_settings"]["view"]["arguments"] = [$nid];
      break;
  }
  return;
}
/**
 * Implements hook_views_pre_build().
 */
function node_elections_views_pre_build(ViewExecutable $view) {
  if ($view->id() == "election_reports_2022") {
    switch ($view->current_display) {
      case "elections_autocomplete":
        break;
      case "election_area_autocomplete":
        $view->setArguments([]);
        break;
      case "election_contest_autocomplete":
        break;
      case "election_candidate_autocomplete":
        break;
    }
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function node_elections_preprocess_taxonomy_term(&$variables) {
  if (isset($variables["term"]) && in_array($variables["term"]->bundle(), [
      "elections",
      "election_areas",
      "elector_groups",
      "election_candidates",
      "election_contests",
    ])) {
    $variables['#attached']['library'][] = 'node_elections/election';
  }
}

/**
 * Implements hook_paragraph_HOOK_summary_alter().
 */
function node_elections_paragraph_election_area_results_summary_alter(array $form_widget, array $para, array $attributes) {
  // TODO: (optionally) Add some summary text here for the elections paragraphs.
}

/**
 * Implements hook_form_ID_alter().
 */
function node_elections_form_taxonomy_overview_terms_alter(&$form, FormStateInterface $form_state) {

  switch ($form_state->getBuildInfo()["args"][0]->get("name")) {
    case "Elections":
      $form['terms']['#header'] = array_merge(array_slice($form['terms']['#header'], 0, 1, TRUE),
        [t('Election Date')],
        array_slice($form['terms']['#header'], 1, NULL, TRUE));
      foreach ($form['terms'] as &$term) {
        if (is_array($term) && !empty($term['#term'])) {
          $election = $term['#term']->field_election_date->value;
          $status['date'] = [
            '#markup' => $election,
            '#type' => 'item',
          ];

          $term = array_slice($term, 0, 1, TRUE) +
            $status +
            array_slice($term, 1, NULL, TRUE);
        }
      }
      break;

    case "Elector Groups":
      $form['terms']['#header'] = array_merge(array_slice($form['terms']['#header'], 0, 1, TRUE),
        [t('Election')],
        array_slice($form['terms']['#header'], 1, NULL, TRUE));
      foreach ($form['terms'] as &$term) {
        if (is_array($term) && !empty($term['#term'])) {
          $election_term_id = $term['#term']->field_election->target_id;
          $field =[
            "#markup" => "<b>** Orphan</b>",
            "#type" => "item",
          ];
          if ($election_term = Term::load($election_term_id)) {
            $election = $election_term->getName();
            $field = [
              '#title' => $election,
              '#url' => Url::fromRoute('entity.taxonomy_term.canonical', ['taxonomy_term' => $election_term_id]),
              '#type' => 'link',
            ];
          }
          $status['election'] = $field;

          $term = array_slice($term, 0, 1, TRUE) +
            $status +
            array_slice($term, 1, NULL, TRUE);
        }
      }
      break;

    case "Election Areas":
      $form['terms']['#header'] = array_merge(array_slice($form['terms']['#header'], 0, 1, TRUE),
        [t('Election')],
        array_slice($form['terms']['#header'], 1, NULL, TRUE));
      foreach ($form['terms'] as &$term) {
        if (is_array($term) && !empty($term['#term'])) {
          $election_term_id = $term['#term']->field_election->target_id;
          $field =[
            "#markup" => "<b>** Orphan</b>",
            "#type" => "item",
          ];
          if ($election_term = Term::load($election_term_id)) {
            $election = $election_term->getName();
            $field = [
              '#title' => $election,
              '#url' => Url::fromRoute('entity.taxonomy_term.canonical', ['taxonomy_term' => $election_term_id]),
              '#type' => 'link',
            ];
          }
          $status['election'] = $field;

          $term = array_slice($term, 0, 1, TRUE) +
            $status +
            array_slice($term, 1, NULL, TRUE);
        }
      }
      break;

    case "Election Contests":
      $form['terms']['#header'] = array_merge(array_slice($form['terms']['#header'], 0, 1, TRUE),
        [t('Election')],
        array_slice($form['terms']['#header'], 1, NULL, TRUE));
      foreach ($form['terms'] as &$term) {
        if (is_array($term) && !empty($term['#term'])) {
          $field = [
            "#markup" => "<b>** Orphan</b>",
            "#type" => "item",
          ];
          $election_term_id = $term['#term']->field_election->target_id;
          if ($election_term = Term::load($election_term_id)) {
            $election = $election_term->getName();
            $field = [
              '#title' => $election,
              '#url' => Url::fromRoute('entity.taxonomy_term.canonical', ['taxonomy_term' => $election_term_id]),
              '#type' => 'link',
            ];
          }

          $status['election'] = $field;

          $term = array_slice($term, 0, 1, TRUE) +
            $status +
            array_slice($term, 1, NULL, TRUE);
        }
      }
      break;

    case "Election Candidates":
      $form['terms']['#header'] = array_merge(array_slice($form['terms']['#header'], 0, 1, TRUE),
        [t('Election')],
        array_slice($form['terms']['#header'], 1, NULL, TRUE));
      foreach ($form['terms'] as &$term) {
        if (is_array($term) && !empty($term['#term'])) {
          $field = [
            "#markup" => "<b>** Orphan</b>",
            "#type" => "item",
          ];
          $contest_term_id = $term['#term']->field_contest->target_id;
          if ($contest_term = Term::load($contest_term_id)) {
            $election_term_id = $contest_term->field_election->target_id;
            $election_term = Term::load($election_term_id);
            $election = $election_term->getName();
            $field = [
              '#title' => $election,
              '#url' => Url::fromRoute('entity.taxonomy_term.canonical', ['taxonomy_term' => $election_term_id]),
              '#type' => 'link',
            ];
          }

          $status['election'] = $field;

          $term = array_slice($term, 0, 1, TRUE) +
            $status +
            array_slice($term, 1, NULL, TRUE);
        }
      }
      break;
  }

}
