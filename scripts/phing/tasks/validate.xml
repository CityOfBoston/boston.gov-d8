<project name="validate" default="validate:all">

  <property description="Defines a Drupal-specific PHP Ruleset."
            name="phpcs.ruleset"
            value="${repo.root}/vendor/drupal/coder/coder_sniffer/Drupal/ruleset.xml"/>

  <!-- Run linter against all php files in repository. -->
  <target name="validate:lint" description="Runs a PHP Lint against all code.">
    <echo message="Using PHP 7 native linting to check for PHP compile errors." level="info"/>
    <phplint level="verbose" errorproperty="lint.error">
      <fileset refid="files.php"/>
    </phplint>
    <if>
      <not>
        <equals arg1="${lint.error}" arg2=""/>
      </not>
      <then>
        <echo message="PHP linting failed: ${lint.error}" level="error"/>
        <fail message="PHP linting failed: ${lint.error}" status="1"/>
      </then>
    </if>
  </target>

  <!-- CODE BELOW IS NOT VERIFIED FOR D8 -->

  <!-- Run all validation targets. -->
  <target name="validate:all" description="Runs all code validation targets."
          depends="validate:lint, validate:phpcs"/>

  <!-- Run code sniffer against all custom code. -->
  <target name="validate:phpcs" description="Runs PHP Code Sniffer against only custom modules.">

    <echo message="Using CodeSniffer (default ruleset) to check for php and js coding standards conformity." level="info"/>
    <!-- Sniff custom modules for Drupal and generic JS coding standards compliance. -->
    <if>
      <equals arg1="${acquia.site_environment}" arg2="dev"/>
      <then>
        <echo message="Note: Any warnings/errors found will be detailed in the file: ${lando.url.url}/validate.txt." level="warning"/>
        <phpcodesniffer
          description="DEV: Sniff custom modules for Drupal coding standards compliance."
          standard="${phpcs.ruleset}"
          showSniffs="false"
          showWarnings="true"
          reportWidth="500"
          haltonerror="false"
          haltonwarning="false">
          <fileset refid="files.codesniffer" description="Use the combined PHP and JS filesets." />
          <formatter type="full" usefile="true" outfile="${docroot}/validate.txt"/>
          <formatter type="summary" usefile="false"/>
        </phpcodesniffer>
        <exec
          description="Grep file to see if it contains any errors."
          command="cat docroot/validate.txt | grep ERROR"
          outputProperty="hello"/>
        <if>
          <not>
            <equals arg1="${hello}" arg2=""/>
          </not>
        <then>
          <echo message="ERRORS Found: Please check the file: ${lando.url.url}/validate.txt" level="error"/>
        </then>
        </if>

      </then>

      <else>
        <phpcodesniffer
          description="PROD/STAGE: Sniff custom modules for Drupal coding standards compliance."
          standard="${phpcs.ruleset}"
          showSniffs="false"
          showWarnings="true"
          haltonerror="true"
          haltonwarning="true">
          <fileset refid="files.codesniffer" description="Use the combined PHP and JS filesets." />
          <formatter type="full" usefile="false"/>
        </phpcodesniffer>
      </else>
    </if>

  </target>

</project>
