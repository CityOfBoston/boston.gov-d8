FROM devwithlando/php:7.1-apache

# Define the name of the working directory in the container.
WORKDIR /app

# Install linux and php packages that are required but not in base-image.
RUN apt-get update && \
    apt-get install -y --no-install-recommends jq zip libvpx-dev libxpm-dev libgd-dev  && \
    docker-php-ext-configure gd --with-freetype-dir=/usr/include/ --with-jpeg-dir=/usr/include/ && \
    docker-php-ext-install pdo_mysql gd bz2

# AWS command so we can sync files from the S3 config bucket.
RUN cd /tmp \
  && curl "https://s3.amazonaws.com/aws-cli/awscli-bundle.zip" -o "awscli-bundle.zip" \
  && unzip awscli-bundle.zip \
  && ./awscli-bundle/install -i /usr/local/aws -b /usr/local/bin/aws \
  && rm awscli-bundle.zip \
  && rm -rf awscli-bundle

# Add composer and phing so we can use them later
RUN curl --silent --show-error https://getcomposer.org/installer | php && \
    mv composer.phar /usr/local/bin/composer && \
    composer global require phing/phing --no-suggest --no-scripts -q && \
    ln -s /root/.composer/vendor/phing/phing/bin/phing /usr/local/bin/

# Add (copy) php.ini and apache.conf files into the container
ADD scripts/phing/files/php_aws.ini /usr/local/etc/php/conf.d/boston-php-ext-drupal8.ini
ADD scripts/phing/files/limit-apache-children.conf /etc/apache2/conf-available/
RUN a2enconf -q limit-apache-children

# Setup apache vhosts
ENV APACHE_DOCUMENT_ROOT /app/docroot
RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf && \
    sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf && \
    a2enmod rewrite

# Add (copy) into the container the (working copy) of the repo
ADD . /app

# Copy the container scripts around within the container
RUN ln -sf ./scripts/docker-terraform/drupal-entrypoint.sh ./scripts/drupal-entrypoint.sh && \
    ln -sf ./scripts/docker-terraform/run-staging-container.sh ./scripts/drupal-entrypoint.sh

# Adds a web console to run drush commands on staging.
ADD scripts/docker-terraform/vendor/webconsole/webconsole.php /app/docroot/
RUN chmod a+rx /app/docroot/webconsole.php

ENTRYPOINT ["/app/scripts/drupal-entrypoint.sh"]

# NOTE: The container content will be "built" (or updated) in ./run-staging-container.sh

# This environment variable overrides the "auto" mode in run-staging-container.sh which decides if the database should
# be built, restored or synchronised.
# Use one of auto, build, sync or restore.
ENV BOSTON_DATABASE_MODE build

 # Default from the base Dockerfile, but when you override ENTRYPOINT you need
 # to override this as well.
CMD ["apache2-foreground"]
